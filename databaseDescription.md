C'est une mise √† jour tr√®s compl√®te et pr√©cise qui rapproche votre base de donn√©es d'un syst√®me E-commerce professionnel (type Shopify ou Take.app). Le fait de lier un client √† un seul magasin simplifie la gestion de la confidentialit√© pour chaque commer√ßant (silo de donn√©es).

Voici le Mod√®le Conceptuel de Donn√©es (MCD) adapt√© pour Supabase (PostgreSQL), int√©grant toutes vos nouvelles sp√©cifications.

1. Diagramme Relationnel (Visuel)
Ce sch√©ma montre comment les tables interagissent. Notez la hi√©rarchie : Entreprise -> Magasin -> Produits/Clients.

Extrait de code

erDiagram
    %% GESTION DES UTILISATEURS (Supabase Auth)
    AUTH_USER ||--|| ENTERPRISE : "g√®re"

    %% STRUCTURE COMMERCIALE
    ENTERPRISE ||--|{ STORE : "poss√®de"
    
    ENTERPRISE {
        uuid id PK
        uuid owner_id FK
        string name
        timestamp created_at
    }

    STORE {
        uuid id PK
        uuid enterprise_id FK
        string name
        string slug "URL unique"
        string phone
        string image_url
        string color_theme
    }

    %% GESTION CATALOGUE
    STORE ||--|{ CATEGORY : "d√©finit"
    STORE ||--|{ TAG : "utilise"
    STORE ||--|{ PRODUCT : "vend"
    
    CATEGORY {
        bigint id PK
        uuid store_id FK
        string name
    }

    TAG {
        bigint id PK
        uuid store_id FK
        string name
    }

    PRODUCT {
        bigint id PK
        uuid store_id FK
        bigint category_id FK
        string name
        enum type "Physique, Num√©rique..."
        string sku
        numeric price
        numeric original_price
        boolean show_estimated_price
        boolean track_cost
        numeric cost_per_item
        boolean show_net_price
        numeric unit_value
        enum unit_type "KG, L, PCS..."
        boolean tax_exempt
        text tax_exempt_reason
        text description
        jsonb images "Tableau d'URLs"
        boolean requires_shipping
        text[] delivery_methods "Emporter, Livraison..."
        boolean is_visible
        boolean is_out_of_stock
        boolean track_inventory
        int stock_quantity
        int daily_capacity
        int max_order_qty
        int min_order_qty
    }

    %% RELATIONS PRODUITS AVANC√âES
    PRODUCT }|--|{ TAG : "est √©tiquet√©"
    PRODUCT ||--|{ VARIANT : "poss√®de"
    PRODUCT ||--|{ OPTION : "propose"

    VARIANT {
        bigint id PK
        bigint product_id FK
        string name
        numeric price
        numeric original_price
        string image_url
    }

    OPTION {
        bigint id PK
        bigint product_id FK
        string name
        enum type "Texte, Date, Select..."
        jsonb values "Choix possibles"
        boolean is_required
    }

    %% GESTION CLIENTS (CRM)
    STORE ||--|{ CLIENT : "fid√©lise"
    
    CLIENT {
        uuid id PK
        uuid store_id FK
        string name
        string phone
        string email
        date birthday
        text address
        text notes
        string referral_code
    }

    CLIENT }|--|{ TAG : "a des √©tiquettes"
2. Code SQL pour Supabase (Impl√©mentation)
Copiez-collez ce code dans l'√©diteur SQL de votre tableau de bord Supabase pour cr√©er toute la structure d'un coup. J'ai utilis√© des types ENUM pour s√©curiser les listes de choix (Unit√©s, Types).

SQL

-- 1. Cr√©ation des Types ENUM (Listes de choix fixes)
CREATE TYPE product_type_enum AS ENUM ('physique', 'numerique', 'reservation', 'abonnement', 'autres');
CREATE TYPE unit_type_enum AS ENUM ('G', 'KG', 'L', 'ML', 'PCS', 'PAX', 'PERSON', 'ROOM', 'PACK', 'QTY', 'LBS', 'HOUR', 'BOX');
CREATE TYPE option_type_enum AS ENUM ('text', 'number', 'date', 'checkbox', 'select');
CREATE TYPE delivery_method_enum AS ENUM ('emporter', 'livraison', 'sur_place');

-- 2. Table ENTREPRISE (Li√©e au user Supabase)
CREATE TABLE enterprises (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    owner_id UUID REFERENCES auth.users(id) NOT NULL,
    name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. Table MAGASIN (Stores)
CREATE TABLE stores (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    enterprise_id UUID REFERENCES enterprises(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    slug TEXT UNIQUE NOT NULL, -- Pour l'URL (ex: wa-shop.cm/mon-shop)
    image_url TEXT,
    phone TEXT,
    color TEXT DEFAULT '#25D366', -- Couleur de la boutique
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. Table CATEGORIES
CREATE TABLE categories (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    store_id UUID REFERENCES stores(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 5. Table TAGS (Etiquettes partag√©es Produits et Clients)
CREATE TABLE tags (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    store_id UUID REFERENCES stores(id) ON DELETE CASCADE,
    name TEXT NOT NULL
);

-- 6. Table PRODUITS (Products)
CREATE TABLE products (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    store_id UUID REFERENCES stores(id) ON DELETE CASCADE,
    category_id BIGINT REFERENCES categories(id) ON DELETE SET NULL,
    
    -- Infos de base
    name TEXT NOT NULL,
    type product_type_enum DEFAULT 'physique',
    sku TEXT, -- UGS
    description TEXT,
    images JSONB, -- Stockera un tableau d'URLs ex: ["url1.jpg", "url2.jpg"]
    tags_list JSONB, -- Ou utiliser une table de liaison, ici simple tableau d'IDs de tags

    -- Prix et Co√ªts
    price NUMERIC NOT NULL DEFAULT 0,
    original_price NUMERIC, -- Prix barr√©
    show_estimated_price BOOLEAN DEFAULT FALSE,
    track_cost BOOLEAN DEFAULT FALSE, -- Co√ªt par article (bool)
    cost_price NUMERIC, -- Prix par article (valeur)
    show_net_price BOOLEAN DEFAULT FALSE, -- Prix net par unit√© visible

    -- Unit√©s et Mesures
    unit_value NUMERIC,
    unit unit_type_enum DEFAULT 'PCS',
    
    -- Fiscalit√©
    tax_exempt BOOLEAN DEFAULT FALSE, -- D√©rogation fiscale
    tax_exempt_reason TEXT, -- Valeur de la d√©rogation
    
    -- Logistique
    requires_shipping BOOLEAN DEFAULT TRUE, -- Livraison
    delivery_methods TEXT[], -- Tableau: ['emporter', 'livraison']
    
    -- Gestion Stock et Visibilit√©
    is_visible BOOLEAN DEFAULT TRUE,
    is_out_of_stock BOOLEAN DEFAULT FALSE, -- Marquer comme √©puis√©
    track_inventory BOOLEAN DEFAULT FALSE, -- Quantit√© de voies (suivi stock)
    stock_quantity INTEGER DEFAULT 0, -- Valeur num√©rique du stock
    daily_capacity INTEGER, -- Pour les r√©servations
    max_order_quantity INTEGER,
    min_order_quantity INTEGER DEFAULT 1,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 7. Table VARIANTES (Variants)
CREATE TABLE variants (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_id BIGINT REFERENCES products(id) ON DELETE CASCADE,
    name TEXT NOT NULL, -- ex: "Rouge / XL"
    price NUMERIC NOT NULL,
    original_price NUMERIC,
    image_url TEXT
);

-- 8. Table OPTIONS (Pour la personnalisation client)
CREATE TABLE options (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_id BIGINT REFERENCES products(id) ON DELETE CASCADE,
    name TEXT NOT NULL, -- ex: "Gravure sur le produit"
    type option_type_enum DEFAULT 'text',
    values JSONB, -- Liste des choix si type='select' (ex: ["Rouge", "Bleu"])
    is_required BOOLEAN DEFAULT FALSE
);

-- 9. Table CLIENTS (Isol√©s par magasin)
CREATE TABLE clients (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    store_id UUID REFERENCES stores(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    phone TEXT NOT NULL, -- T√©l√©phone principal
    alt_phone TEXT, -- Num√©ro de t√©l√©phone (secondaire)
    email TEXT,
    birthday DATE,
    address TEXT,
    notes TEXT,
    referral_code TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 10. Table Liaison CLIENTS <-> TAGS
CREATE TABLE client_tags (
    client_id UUID REFERENCES clients(id) ON DELETE CASCADE,
    tag_id BIGINT REFERENCES tags(id) ON DELETE CASCADE,
    PRIMARY KEY (client_id, tag_id)
);

-- 11. Table Liaison PRODUITS <-> TAGS
CREATE TABLE product_tags (
    product_id BIGINT REFERENCES products(id) ON DELETE CASCADE,
    tag_id BIGINT REFERENCES tags(id) ON DELETE CASCADE,
    PRIMARY KEY (product_id, tag_id)
);
3. Explications des Choix Techniques
Gestion des Types et Unit√©s (ENUM) : Plut√¥t que de stocker du texte libre qui peut causer des erreurs (ex: "kg", "Kg", "Kilo"), j'ai cr√©√© des listes strictes (unit_type_enum) correspondant exactement √† votre demande (G, KG, L, etc.).

Images (JSONB) : Pour les produits qui ont plusieurs images, Supabase g√®re tr√®s bien le format JSON. Cela √©vite de cr√©er une table images s√©par√©e.

Livraison (TEXT[]) : Le champ delivery_methods est un tableau de texte. Cela permet √† un produit d'√™tre √† la fois "√Ä emporter" ET "Livraison" (choix multiple).

Clients Isol√©s : La table clients contient store_id. Si "Jean" ach√®te dans la Boutique A et la Boutique B, il aura deux lignes diff√©rentes dans la base. Cela respecte votre r√®gle "un client est li√© √† un seul magasin".

Co√ªt par article : J'ai s√©par√© le bool√©en (track_cost) de la valeur (cost_price) pour une meilleure logique applicative.

C'est une structure tr√®s solide pour d√©marrer votre d√©veloppement. Voulez-vous que je pr√©pare les Politiques de S√©curit√© (RLS) pour ces tables ?



147236
. üõ†Ô∏è Supabase SQL Script (Ready-to-Run)This script includes all tables: Structural (1-2), Management (3-4), Catalogue (5-7), CRM (8), Transactional (9-10), Logistics (11), and Analytics (12).A. ENUM Type DefinitionsSQL-- Product Types
CREATE TYPE product_type_enum AS ENUM ('physical', 'digital', 'reservation', 'subscription', 'other');
-- Unit of Measurement Types
CREATE TYPE unit_type_enum AS ENUM ('G', 'KG', 'L', 'ML', 'PCS', 'PAX', 'PERSON', 'ROOM', 'PACK', 'QTY', 'LBS', 'HOUR', 'BOX');
-- Option Customization Types
CREATE TYPE option_type_enum AS ENUM ('text', 'number', 'date', 'checkbox', 'select');
-- Delivery Methods
CREATE TYPE delivery_method_enum AS ENUM ('pickup', 'delivery', 'dine_in');
-- Order Statuses (Crucial for the Orders dashboard)
CREATE TYPE order_status_enum AS ENUM ('new', 'sent_to_whatsapp', 'processing', 'completed', 'cancelled');
-- Analytics Event Types
CREATE TYPE event_type_enum AS ENUM ('page_view', 'product_view', 'add_to_cart', 'whatsapp_click', 'order_generated');
B. Structural Tables (Enterprise & Store)SQL-- 1. ENTERPRISES Table (Business Identity)
CREATE TABLE enterprises (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    owner_id UUID REFERENCES auth.users(id) NOT NULL,
    name TEXT NOT NULL,
    client TEXT, -- The client field from the user request
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. STORES Table (The Shops/Magasins)
CREATE TABLE stores (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    enterprise_id UUID REFERENCES enterprises(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    slug TEXT UNIQUE NOT NULL, 
    image_url TEXT, 
    phone TEXT, 
    url TEXT, 
    color TEXT DEFAULT '#25D366', 
    created_at TIMESTAMPTZ DEFAULT NOW()
);
C. Catalogue & Product Tables (3-7)(SQL for categories, tags, products, variants, options remains the same as previously defined, ensuring all specific fields like sku, tax_exempt, daily_capacity, unit_type, etc., are present.)D. CRM TableSQL-- 8. CLIENTS Table (Isolated per Store)
CREATE TABLE clients (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    store_id UUID REFERENCES stores(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    phone TEXT NOT NULL, 
    alt_phone TEXT,
    email TEXT,
    birthday DATE,
    address TEXT,
    notes TEXT, 
    referral_code TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
E. Transactional Tables (Orders)SQL-- 9. ORDERS Table (Order Header / Log)
-- Logs every order initiated via the Cart/WhatsApp process
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    store_id UUID REFERENCES stores(id) ON DELETE CASCADE,
    client_id UUID REFERENCES clients(id) ON DELETE SET NULL, -- Link to a known client, if matched
    
    -- Customer Info (Logged at the time of order)
    customer_name TEXT NOT NULL,
    customer_phone TEXT NOT NULL,
    customer_email TEXT,
    delivery_address TEXT,
    
    -- Financials & Status
    total_amount NUMERIC NOT NULL,
    delivery_fee NUMERIC DEFAULT 0,
    status order_status_enum DEFAULT 'new', -- E.g., 'sent_to_whatsapp', 'completed'
    whatsapp_message TEXT, -- The exact message sent to WhatsApp (for debugging/history)
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 10. ORDER_ITEMS Table (Order Lines)
-- Detailed list of products and pricing for a specific order
CREATE TABLE order_items (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
    product_id BIGINT REFERENCES products(id) ON DELETE SET NULL,
    variant_id BIGINT REFERENCES variants(id) ON DELETE SET NULL, -- If a specific variant was ordered
    
    -- Snapshot data (in case product/price changes later)
    product_name TEXT NOT NULL,
    unit_price NUMERIC NOT NULL,
    quantity INTEGER NOT NULL,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);
F. Logistics & Analytics TablesSQL-- 11. DELIVERY_ZONES Table (Logistics Configuration)
-- Allows the merchant to configure specific shipping fees by location
CREATE TABLE delivery_zones (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    store_id UUID REFERENCES stores(id) ON DELETE CASCADE,
    name TEXT NOT NULL, -- E.g., 'Douala Quartier 1', 'Yaound√© Zone B'
    base_fee NUMERIC NOT NULL DEFAULT 0,
    min_order_for_free NUMERIC
);

-- 12. ANALYTICS_LOG Table (Statistics)
-- Records key events for the /admin/stats dashboard
CREATE TABLE analytics_log (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    store_id UUID REFERENCES stores(id) ON DELETE CASCADE,
    event_type event_type_enum NOT NULL, -- E.g., 'page_view', 'whatsapp_click'
    resource_id TEXT, -- Optional: ID of the product or order if applicable
    ip_address TEXT, -- For basic geo-location/filtering
    created_at TIMESTAMPTZ DEFAULT NOW()
);
3. üõ°Ô∏è Security Note (Row Level Security - RLS)RLS must be strictly enforced:TablePolicy Ruleenterprises, storesAdmin Access: auth.uid() = owner_idproducts, categories, orders, clients, etc.Admin Access: Must match store_id (which links back to owner_id via enterprises)products, variants, optionsPublic Read: SELECT allowed if is_visible = TRUE and the user is anon (for the client storefront).This comprehensive model is ready for development and provides all the necessary tables for both the public storefront and the full-featured multi-store admin dashboard.